{% extends "base.html" %}

{% block sidebar %}
<style>
    .list-group-item {
        background-color: #343a40;
    }

    .list-group-item:hover {
        background-color: black;
    }

    .list-group-item.active {
        background-color: rgb(82, 82, 82);
    }

    /* Modify scrollbar */
    /* width */
    ::-webkit-scrollbar {
        width: 8px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
        background: #343a40;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
        background: #888;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
<div class="h-100 bg-dark text-white overflow-auto py-4">
    <h3 class="text-center mb-3 px-4">Upload History</h3>
    <ul class="list-group" id="history-list">
        {% for history in histories %}
        {% if request.args.get('generation_id') == history.id|string %}
        <a href="{{ url_for('main.index') + '?generation_id=' + history.id|string }}"
            class="list-group-item list-group-item-action text-white text-nowrap text-truncate pl-4 show active">
            {{ history.caption }}
        </a>
        {% else %}
        <a href="{{ url_for('main.index') + '?generation_id=' + history.id|string }}"
            class="list-group-item list-group-item-action text-white text-nowrap text-truncate pl-4 show">
            {{ history.caption }}
        </a>
        {% endif %}
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
<style>
    .wrapper {
        position: relative;
        height: 500px;
        width: 100%;
        border-radius: 10px;
        background: #fff;
        border: 2px dashed #c2cdda;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .wrapper.active {
        border: none;
    }

    .wrapper .image {
        position: absolute;
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .wrapper img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }

    .wrapper .icon {
        font-size: 100px;
        color: #9658fe;
    }

    .wrapper .text {
        font-size: 20px;
        font-weight: 500;
        color: #5B5B7B;
    }

    .wrapper #cancel-btn i {
        position: absolute;
        font-size: 20px;
        right: 15px;
        top: 15px;
        color: #9658fe;
        cursor: pointer;
        display: none;
    }

    .wrapper.active:hover #cancel-btn i {
        display: block;
    }

    .wrapper #cancel-btn i:hover {
        color: #e74c3c;
    }

    .wrapper .file-name {
        position: absolute;
        bottom: 0px;
        width: 100%;
        padding: 8px 0;
        font-size: 18px;
        color: #fff;
        display: none;
        background: linear-gradient(135deg, #3a8ffe 0%, #9658fe 100%);
    }

    .wrapper.active:hover .file-name {
        display: block;
    }
</style>
<div class="contrainer-fluid overflow-auto">

    <div class="container text-center flex-grow-1 p-5">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-danger" role="alert">
            {{ messages[0] }}
        </div>
        {% endif %}
        {% endwith %}
        <div class="wrapper mb-4">
            <div class="image" role="button" onclick="defaultBtnActive()">
                {% if image_path != '' %}
                <img id="preview" src="{{ url_for('main.load_image', filename=image_path) }}" alt="Upload image here"
                    onerror="this.style.display='none'">
                {% else %}
                <img id="preview" src="" alt="Upload image here" onerror="this.style.display='none'">
                {% endif %}
            </div>
            <div class="content">
                <div class="icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="text">
                    No file chosen, yet!
                </div>
            </div>
            <div id="cancel-btn">
                <i class="fas fa-times"></i>
            </div>
            <div class="file-name">
                File name here
            </div>
        </div>
        <input id="default-btn" type="file" accept="image/*" hidden>

        <label for="captioner">Select Model:</label>
        <select id="captioner" class="form-control">
            <option value="vit-indobert">VIT + IndoBERT</option>
            <option value="deit-indobert">DEIT + IndoBERT</option>
            <option value="dinov2-indobert">DINO V2 + IndoBERT</option>
            <option value="vit-gpt2">VIT + GPT-2 (English)</option>
        </select>
        <button class="btn btn-primary w-100 p-2 font-weight-bold mt-3" id="generateButton"
            onclick="generate_caption()">Generate Caption</button>
        <button class="btn btn-primary w-100 p-2 font-weight-bold mt-3" id="generateLoading" style="display: none;"
            disabled>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Loading...
        </button>
        <h3 id="resultLabel" class="mt-3">{{ caption }}</h3>
    </div>
</div>
<script> // script for image upload styling
    const wrapper = document.querySelector(".wrapper");
    const fileName = document.querySelector(".file-name");
    const defaultBtn = document.querySelector("#default-btn");
    const customBtn = document.querySelector("#custom-btn");
    const cancelBtn = document.querySelector("#cancel-btn i");
    const preview = document.querySelector("#preview");
    const img = document.querySelector("img");
    let regExp = /[0-9a-zA-Z\^\&\'\@\{\}\[\]\,\$\=\!\-\#\(\)\.\%\+\~\_ ]+$/;
    let isImageChanged = false;                 // variable to mark if image changed (if so, make new generation; else, edit current generation)

    function defaultBtnActive() {
        defaultBtn.click();
    }
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    defaultBtn.addEventListener("change", function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function () {
                const result = reader.result;           // get source value
                img.src = result;                       // assign to image src
                wrapper.classList.add("active");
                preview.style.display = "block";
            }
            cancelBtn.addEventListener("click", function () {
                img.src = "";
                wrapper.classList.remove("active");
            })
            reader.readAsDataURL(file);
        } else {
            img.src = "";
            wrapper.classList.remove("active")
        }
        isImageChanged = true;

        if (this.value) {
            let valueStore = this.value.match(regExp);
            fileName.textContent = valueStore;
        }
    });
</script>

<style>
    /* css for animating add new history */
    ul a {
        transition: all 0.5s ease-out;
        opacity: 0;
    }

    ul a.show {
        opacity: 1;
    }
</style>
<script> // script for animating add new history to list (called in generating caption script)
    function add_new_history(href) {
        var list = document.getElementById('history-list');
        var newList = document.createElement('a');
        newList.href = href;
        newList.classList.add("list-group-item", "list-group-item-action", "text-white", "text-nowrap", "text-truncate", "pl-4", "active")
        list.insertBefore(newList, list.firstChild);
        setTimeout(function () {
            newList.classList.add("show");
        }, 10);
        return newList;
    }
</script>

<script> // script for generating caption
    function showLoading() {
        document.getElementById("generateButton").style.display = "none";
        document.getElementById("generateLoading").style.display = "inline";
    }
    function hideLoading() {
        document.getElementById("generateButton").style.display = "inline";
        document.getElementById("generateLoading").style.display = "none";
    }

    function generate_caption() {
        const captioner = document.getElementById("captioner").value;
        const imageFile = document.getElementById("default-btn");
        const resultLabel = document.getElementById("resultLabel");

        const urlParams = new URLSearchParams(window.location.search);
        const params = Object.fromEntries(urlParams.entries());

        resultLabel.textContent = "";
        showLoading();

        const formData = new FormData();
        formData.append("captioner", captioner);
        
        if (isImageChanged && imageFile.files[0]) {                                     // if image changed and file not blank, make new generation
            formData.append("edit", "false");
            formData.append("image", imageFile.files[0]);
        } else if (!isImageChanged && "{{image_path != ''}}" == "True") {               // if image not changed and image_path not blank, edit caption in current generation_id
            formData.append("edit", params["generation_id"]);
            formData.append("image", "{{image_path}}")
        } else if (!isImageChanged && imageFile.files[0]) {                             // if image not changed and file not blank, edit caption in current generation_id
            formData.append("edit", params["generation_id"]);
            formData.append("image", imageFile.files[0])
        } else {
            alert("Please select an image.");
            hideLoading();
            return;
        }

        fetch("/generate_caption", {
            method: "POST",
            body: formData
        })
            .then(response => response.json())
            .then(async data => {
                hideLoading();

                const params = {
                    generation_id: data["generation_id"],
                };
                const searchParams = new URLSearchParams(params);                      // this is the params that will be used by get tmethod
                const href = "{{ url_for('main.index') }}" + "?" + searchParams
                history.pushState({}, null, href);                                     // change address bar without refreshing page

                let curList = null;
                if (isImageChanged) {
                    document.getElementsByClassName('active')[0].classList.remove("active");
                    curList = add_new_history(href);
                } else {
                    curList = document.querySelectorAll(`a[href='${href}']`)[0];
                    curList.innerHTML = "";
                }
                const predictedCaption = data["caption"];
                for (let i = 0; i < predictedCaption.length; i++) {
                    resultLabel.innerHTML += predictedCaption.charAt(i);
                    curList.innerHTML += predictedCaption.charAt(i);
                    await sleep(30);
                }
                isImageChanged = false;                                                // set flag back to false, so that if user generate caption without changing image, it will not make new generation
            })
    }
</script>
{% endblock %}